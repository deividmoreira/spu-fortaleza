<?php
$this->breadcrumbs()->addPage('Tramitação', 'processos');
echo $this->breadcrumbs()->render();

echo $this->render('snippets/abasTramitacao.phtml');

echo $this->pagenav()->openList();

$html = '<div class="total_documents">Total de itens: <strong>' . $this->totalDocumentos . '</strong></div>';
echo $this->pagenav()->customHelperLinks($html);

echo $this->pagenav()->closeList();
?>

<div id="article">
    <?php echo $this->render('snippets/formularioPesquisaRapidaProcesso.phtml') ?>

    <form action="<?php echo $this->simpleUrl('receber') ?>" method="post">
        <?php
        echo $this->buttonlist()->open();
        echo $this->buttonlist()->defaultBlockActionsDescription();
        echo $this->buttonlist()->button('Receber', null, array(), array("action" => $this->simpleUrl('receber-entrada', 'processos-ajax')));
        echo $this->buttonlist()->close(true);
        ?>
        <div id="grid"></div>
        <?php
        if ($this->paginator) :
            echo $this->partial('snippets/gridProcessos.phtml', array('paginator' => $this->paginator, 'exibirCheckbox' => true, 'indicarPrioritarios' => true));
        else :
            $js = '
                $(function(){
                    $.ajax({
                        type: "post",
                        url: "' . $this->simpleUrl('caixa-entrada', 'processos-ajax') . '",
                        success: function(retorno){
                            $("#grid").html(retorno);
                        }
                    });
                });
                ';
            $this->headScript()->appendScript($js);
        endif;
        ?>
    </form>
</div>

<?php
$js = '
    $(function(){
        $("button").live("click", function(){
            var action = $(this).attr("action")
            if (action != undefined) {
                var selecionados = $("tr.marked")
                if (selecionados.length > 0 && selecionados.length < 11) {
                
                    var processos = []
                    selecionados.each(function(index){
                        processos.push($(this).find("td:first input").val())
                    });
                    
                    processos.reverse()
                    retorno = true
                    processo = processos.pop()
                    quantidade_processos = processos.length
                    var intervalo = setInterval(function(){
                        if (processo == undefined) {
                            clearInterval(intervalo);
                            window.location = "' . $this->baseUrl() . '/entrada/receber-ok"
                        } else {
                            if (processos.length != quantidade_processos) {
                                quantidade_processos = processos.length
                                retorno = true
                            }
                            if (retorno) {
                                retorno = false
                                linha = $("tr.marked:first")
                                $.ajax({
                                    type: "post",
                                    data: {"processoId" : processo},
                                    url: action,
                                    beforeSend: function(){
                                        linha.find("input").hide()
                                        linha.find("td:first").append("<img id=\"indicator\" src=\"' . $this->baseUrl() . '/img/indicator.gif\">");
                                        linha.attr("style", "opacity:0.4;")
                                    },
                                    success: function(retorno){
                                        linha.remove()
                                        processo = processos.pop()
                                    },
                                    error: function(retorno) {
                                        var numero_processo = linha.find("td:eq(2)").html().replace(/\//g, "_")
                                        window.location = "' . $this->baseUrl() . '/entrada/receber-falha/np/" + numero_processo
                                    }
                                });
                                
                            }
                        }
                    }, 200);
                    
                    return false;
                }
            }
        });
    });
    ';
$this->headScript()->appendScript($js);
?>